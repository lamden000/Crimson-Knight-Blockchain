<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw Coin - Mint Game Token</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box.error {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .status-box.success {
            border-left-color: #27ae60;
            background: #efe;
        }

        .status-box.info {
            border-left-color: #3498db;
            background: #eef;
        }

        .status-text {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .wallet-info {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-top: 5px;
        }

        .coin-info {
            background: #fff9e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí∞ Withdraw Coin</h1>
        <p class="subtitle">Mint Game Token (GTK) t·ª´ coin trong game</p>

        <div id="statusBox" class="status-box info">
            <div class="status-text">ƒêang ch·ªù k·∫øt n·ªëi MetaMask...</div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <strong>ƒê·ªãa ch·ªâ v√≠:</strong>
            <div class="wallet-address" id="walletAddress"></div>
            <div class="network-info" id="networkInfo"></div>
        </div>

        <div id="coinInfo" class="coin-info" style="display: none;">
            <strong>Th√¥ng tin Withdraw:</strong>
            <div style="margin-top: 10px;">
                <div>S·ªë coin: <strong id="coinAmount">0</strong></div>
                <div>S·ªë token s·∫Ω nh·∫≠n: <strong id="tokenAmount">0</strong> GTK</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    T·ª∑ l·ªá: 1 coin = 1 GTK token
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="contractAddress">Contract Address (GameToken):</label>
            <input type="text" id="contractAddress" placeholder="0x..." value="" readonly>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">T·ª± ƒë·ªông t·ª´ game - kh√¥ng th·ªÉ ch·ªânh s·ª≠a</small>
        </div>

        <button id="connectBtn" onclick="connectWallet()">üîó K·∫øt n·ªëi MetaMask</button>
        <button id="switchNetworkBtn" onclick="switchToAmoy()" disabled class="button-secondary" style="display: none; background: #6c757d;">üîÑ Chuy·ªÉn sang Polygon Amoy</button>
        <button id="mintBtn" onclick="mintTokens()" disabled>üí∞ Mint Game Token</button>
        <button id="checkBalanceBtn" onclick="checkTokenBalance()" disabled class="button-secondary" style="background: #6c757d;">üìä Ki·ªÉm tra s·ªë d∆∞ GTK</button>
    </div>

    <script>
        let web3;
        let userAccount;
        let contract;
        let contractAddress = '';
        let coinAmount = 0;

        // ABI c·ªßa contract GameToken (SpiritShard)
        const GAME_TOKEN_ABI = [
            {
                "inputs": [],
                "name": "mintForYourself",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
                "name": "mintAmount",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "MINT_AMOUNT",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // L·∫•y parameters t·ª´ URL
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            const address = params.get('contract');
            if (address) {
                document.getElementById('contractAddress').value = address;
                contractAddress = address;
            } else {
                showStatus('‚ö†Ô∏è Contract Address ch∆∞a ƒë∆∞·ª£c set. Vui l√≤ng m·ªü l·∫°i t·ª´ game.', 'error');
            }
            
            const amount = params.get('amount');
            if (amount) {
                coinAmount = parseInt(amount) || 0;
                updateCoinInfo();
            }
        }

        function updateCoinInfo() {
            if (coinAmount > 0) {
                document.getElementById('coinInfo').style.display = 'block';
                document.getElementById('coinAmount').textContent = coinAmount;
                document.getElementById('tokenAmount').textContent = coinAmount; // 1 coin = 1 token
            }
        }

        function showStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.querySelector('.status-text').textContent = message;
        }

        // Ki·ªÉm tra protocol
        function checkProtocolOnLoad() {
            if (window.location.protocol === 'file:') {
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - Vui l√≤ng ch·∫°y qua HTTP server!', 'error');
                return false;
            }
            return true;
        }

        // K·∫øt n·ªëi MetaMask
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t! Vui l√≤ng c√†i ƒë·∫∑t MetaMask extension.', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang y√™u c·∫ßu k·∫øt n·ªëi MetaMask... Vui l√≤ng x√°c nh·∫≠n trong popup MetaMask.', 'info');

                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerHTML = '<span class="loading"></span>ƒêang ch·ªù x√°c nh·∫≠n...';

                // Revoke permissions tr∆∞·ªõc ƒë·ªÉ force popup
                try {
                    const permissions = await window.ethereum.request({
                        method: 'wallet_getPermissions'
                    });
                    
                    if (permissions && permissions.length > 0) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_revokePermissions',
                                params: [{ eth_accounts: {} }]
                            });
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (e) {
                            console.log('Cannot revoke permissions');
                        }
                    }
                } catch (e) {
                    console.log('wallet_getPermissions not supported');
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length === 0) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                    return;
                }

                userAccount = accounts[0];

                web3 = new Web3(window.ethereum);

                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';

                const chainId = await web3.eth.getChainId();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    5: 'Goerli Testnet',
                    11155111: 'Sepolia Testnet',
                    80001: 'Mumbai Testnet',
                    80002: 'Polygon Amoy Testnet',
                    137: 'Polygon Mainnet',
                    1337: 'Localhost',
                    31337: 'Hardhat'
                };
                const networkName = networkNames[chainId] || `Chain ID: ${chainId}`;
                document.getElementById('networkInfo').textContent = `Network: ${networkName}`;

                await ensureAmoyNetwork();

                if (!contractAddress) {
                    showStatus('‚ö†Ô∏è Contract Address ch∆∞a ƒë∆∞·ª£c set t·ª´ game!', 'error');
                    return;
                }

                if (!web3.utils.isAddress(contractAddress)) {
                    showStatus('‚ùå Contract Address kh√¥ng h·ª£p l·ªá!', 'error');
                    return;
                }

                contractAddress = web3.utils.toChecksumAddress(contractAddress);
                document.getElementById('contractAddress').value = contractAddress;

                contract = new web3.eth.Contract(GAME_TOKEN_ABI, contractAddress);

                try {
                    await contract.methods.symbol().call();
                    console.log('Contract connection verified');
                } catch (testError) {
                    showStatus('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi contract. Ki·ªÉm tra l·∫°i address v√† network.', 'error');
                    return;
                }

                document.getElementById('connectBtn').innerHTML = 'üîó ƒê√£ k·∫øt n·ªëi';
                document.getElementById('checkBalanceBtn').disabled = false;

                const currentChainId = await web3.eth.getChainId();
                if (currentChainId != 80002) {
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('switchNetworkBtn').disabled = false;
                    document.getElementById('mintBtn').disabled = true;
                    showStatus(`‚ö†Ô∏è ƒêang ·ªü network kh√°c (Chain ID: ${currentChainId}). Vui l√≤ng chuy·ªÉn sang Polygon Amoy (80002)`, 'error');
                } else {
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    document.getElementById('mintBtn').disabled = false;
                    showStatus(`‚úÖ ƒê√£ k·∫øt n·ªëi! ƒê·ªãa ch·ªâ: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}`, 'success');
                }

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        showStatus('‚ö†Ô∏è MetaMask ƒë√£ b·ªã ng·∫Øt k·∫øt n·ªëi', 'error');
                        location.reload();
                    } else {
                        userAccount = accounts[0];
                        document.getElementById('walletAddress').textContent = userAccount;
                        showStatus('‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi t√†i kho·∫£n', 'success');
                    }
                });

                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                
                if (error.code === 4001) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                } else if (error.code === -32002) {
                    showStatus('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n t·ª´ MetaMask...', 'info');
                } else {
                    showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                }
            }
        }

        // Chuy·ªÉn sang Polygon Amoy
        async function switchToAmoy() {
            await ensureAmoyNetwork();
        }

        // ƒê·∫£m b·∫£o ƒëang ·ªü Polygon Amoy
        async function ensureAmoyNetwork() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    return false;
                }

                const chainId = await web3.eth.getChainId();
                const amoyChainId = '0x13882';

                if (chainId == 80002) {
                    return true;
                }

                showStatus('‚è≥ ƒêang chuy·ªÉn sang Polygon Amoy Testnet...', 'info');

                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: amoyChainId }],
                    });
                    showStatus('‚úÖ ƒê√£ chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                    setTimeout(() => location.reload(), 1500);
                    return true;
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: amoyChainId,
                                    chainName: 'Polygon Amoy Testnet',
                                    nativeCurrency: {
                                        name: 'POL',
                                        symbol: 'POL',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://rpc-amoy.polygon.technology'],
                                    blockExplorerUrls: ['https://www.oklink.com/amoy']
                                }],
                            });
                            showStatus('‚úÖ ƒê√£ th√™m v√† chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                            setTimeout(() => location.reload(), 1500);
                            return true;
                        } catch (addError) {
                            showStatus('‚ùå Kh√¥ng th·ªÉ th√™m Polygon Amoy network.', 'error');
                            return false;
                        }
                    } else if (switchError.code === 4001) {
                        showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi chuy·ªÉn network', 'error');
                        return false;
                    } else {
                        showStatus('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn network.', 'error');
                        return false;
                    }
                }
            } catch (error) {
                console.error('Error ensuring Amoy network:', error);
                return false;
            }
        }

        // Mint tokens (g·ªçi mintForYourself nhi·ªÅu l·∫ßn)
        async function mintTokens() {
            try {
                if (!contract || !userAccount) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                    return;
                }

                const currentChainId = await web3.eth.getChainId();
                if (currentChainId != 80002) {
                    showStatus('‚ö†Ô∏è Vui l√≤ng chuy·ªÉn sang Polygon Amoy Testnet tr∆∞·ªõc!', 'error');
                    return;
                }

                if (coinAmount <= 0) {
                    showStatus('‚ùå S·ªë coin kh√¥ng h·ª£p l·ªá!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang ∆∞·ªõc t√≠nh gas...', 'info');
                document.getElementById('mintBtn').disabled = true;
                document.getElementById('mintBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                // Convert coin amount to wei (1 coin = 1 token = 1 * 10^18 wei)
                const amountInWei = web3.utils.toWei(coinAmount.toString(), 'ether');

                // Estimate gas cho mintAmount
                let gasEstimate;
                try {
                    gasEstimate = await contract.methods.mintAmount(amountInWei).estimateGas({
                        from: userAccount
                    });
                    gasEstimate = Math.floor(gasEstimate * 1.2);
                } catch (estimateError) {
                    gasEstimate = 200000;
                }

                // Ki·ªÉm tra balance
                try {
                    const balance = await web3.eth.getBalance(userAccount);
                    const gasPrice = await web3.eth.getGasPrice();
                    const gasCost = web3.utils.toBN(gasEstimate).mul(web3.utils.toBN(gasPrice));
                    if (web3.utils.toBN(balance).lt(gasCost)) {
                        showStatus('‚ùå Kh√¥ng ƒë·ªß POL ƒë·ªÉ tr·∫£ gas fee!', 'error');
                        document.getElementById('mintBtn').innerHTML = 'üí∞ Mint Game Token';
                        document.getElementById('mintBtn').disabled = false;
                        return;
                    }
                } catch (balanceError) {
                    console.warn('Could not check balance');
                }

                // L·∫•y gas price
                let txParams = {
                    from: userAccount,
                    gas: gasEstimate
                };

                try {
                    const block = await web3.eth.getBlock('latest');
                    const baseFee = block.baseFeePerGas || await web3.eth.getGasPrice();
                    const maxPriorityFeePerGas = web3.utils.toWei('2', 'gwei');
                    const maxFeePerGas = web3.utils.toBN(baseFee).mul(web3.utils.toBN(2)).add(web3.utils.toBN(maxPriorityFeePerGas)).toString();
                    txParams.maxFeePerGas = maxFeePerGas;
                    txParams.maxPriorityFeePerGas = maxPriorityFeePerGas;
                } catch (eip1559Error) {
                    try {
                        txParams.gasPrice = await web3.eth.getGasPrice();
                    } catch (gasPriceError) {
                        txParams.gasPrice = web3.utils.toWei('30', 'gwei');
                    }
                }

                showStatus(`‚è≥ ƒêang mint ${coinAmount} GTK token...`, 'info');

                // Mint tokens v·ªõi s·ªë l∆∞·ª£ng t√πy ch·ªânh (1 l·∫ßn g·ªçi)
                try {
                    const tx = await contract.methods.mintAmount(amountInWei).send(txParams);
                    showStatus(`‚úÖ ƒê√£ mint th√†nh c√¥ng ${coinAmount} GTK token! Transaction: ${tx.transactionHash}`, 'success');
                    setTimeout(checkTokenBalance, 2000);
                } catch (mintError) {
                    console.error('Error minting tokens:', mintError);
                    if (mintError.message && mintError.message.includes('user rejected')) {
                        showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi giao d·ªãch mint token', 'error');
                    } else {
                        showStatus(`‚ùå L·ªói mint token: ${mintError.message}`, 'error');
                    }
                }

                document.getElementById('mintBtn').innerHTML = 'üí∞ Mint Game Token';
                document.getElementById('mintBtn').disabled = false;

            } catch (error) {
                console.error('Error minting tokens:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                document.getElementById('mintBtn').innerHTML = 'üí∞ Mint Game Token';
                document.getElementById('mintBtn').disabled = false;
            }
        }

        // Ki·ªÉm tra s·ªë d∆∞ token
        async function checkTokenBalance() {
            try {
                if (!contract || !userAccount) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang ki·ªÉm tra...', 'info');

                const balance = await contract.methods.balanceOf(userAccount).call();
                const balanceInGTK = web3.utils.fromWei(balance, 'ether');

                showStatus(`üìä S·ªë d∆∞ GTK c·ªßa b·∫°n: ${balanceInGTK} GTK`, 'success');

            } catch (error) {
                console.error('Error checking balance:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', () => {
            getURLParams();
            checkProtocolOnLoad();
        });
    </script>
</body>
</html>


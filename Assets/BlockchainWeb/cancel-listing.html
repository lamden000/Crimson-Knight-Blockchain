<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Listing - Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }

        .status-box.error {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .status-box.success {
            border-left-color: #27ae60;
            background: #efe;
        }

        .status-box.info {
            border-left-color: #3498db;
            background: #eef;
        }

        .status-text {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .wallet-info {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-top: 5px;
        }

        .item-info {
            background: #ffe6e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #e74c3c;
        }

        input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö´ H·ªßy B√°n Item</h1>
        <p class="subtitle">H·ªßy listing item tr√™n marketplace</p>

        <div id="statusBox" class="status-box info">
            <div class="status-text">ƒêang ch·ªù k·∫øt n·ªëi MetaMask...</div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <strong>ƒê·ªãa ch·ªâ v√≠:</strong>
            <div class="wallet-address" id="walletAddress"></div>
            <div class="network-info" id="networkInfo"></div>
        </div>

        <div id="itemInfo" class="item-info" style="display: none;">
            <strong>Token ID:</strong>
            <div id="tokenId" style="font-family: 'Courier New', monospace; font-size: 12px; margin-top: 5px;"></div>
        </div>

        <div class="form-group">
            <label for="marketplaceAddress">Marketplace Contract:</label>
            <input type="text" id="marketplaceAddress" placeholder="0x..." value="" readonly>
        </div>

        <button id="connectBtn" onclick="connectWallet()">üîó K·∫øt n·ªëi MetaMask</button>
        <button id="switchNetworkBtn" onclick="switchToAmoy()" disabled class="button-secondary" style="display: none;">üîÑ Chuy·ªÉn sang Polygon Amoy</button>
        <button id="cancelBtn" onclick="cancelListing()" disabled>üö´ H·ªßy B√°n</button>
    </div>

    <script>
        let web3;
        let userAccount;
        let marketplaceContract;
        let marketplaceAddress = '';
        let tokenId = '';

        // ABI c·ªßa Marketplace contract - ch·ªâ c·∫ßn cancelListing
        const MARKETPLACE_ABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
                ],
                "name": "cancelListing",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // L·∫•y parameters t·ª´ URL
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            marketplaceAddress = params.get('marketplace') || '';
            tokenId = params.get('tokenId') || '';

            if (marketplaceAddress) {
                document.getElementById('marketplaceAddress').value = marketplaceAddress;
            }
            if (tokenId) {
                document.getElementById('tokenId').textContent = tokenId;
                document.getElementById('itemInfo').style.display = 'block';
            }
        }

        function showStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.querySelector('.status-text').textContent = message;
        }

        // K·∫øt n·ªëi MetaMask
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang y√™u c·∫ßu k·∫øt n·ªëi MetaMask... Vui l√≤ng x√°c nh·∫≠n trong popup MetaMask.', 'info');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerHTML = '<span class="loading"></span>ƒêang ch·ªù x√°c nh·∫≠n...';

                // Revoke permissions tr∆∞·ªõc ƒë·ªÉ force popup ch·ªçn t√†i kho·∫£n
                try {
                    const permissions = await window.ethereum.request({
                        method: 'wallet_getPermissions'
                    });
                    
                    if (permissions && permissions.length > 0) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_revokePermissions',
                                params: [{ eth_accounts: {} }]
                            });
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (e) {
                            console.log('Cannot revoke permissions:', e);
                        }
                    }
                } catch (e) {
                    console.log('wallet_getPermissions not supported:', e);
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                    return;
                }

                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);

                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';

                const chainId = await web3.eth.getChainId();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    80002: 'Polygon Amoy Testnet',
                    137: 'Polygon Mainnet'
                };
                const networkName = networkNames[chainId] || `Chain ID: ${chainId}`;
                document.getElementById('networkInfo').textContent = `Network: ${networkName}`;

                await ensureAmoyNetwork();

                if (!marketplaceAddress) {
                    showStatus('‚ö†Ô∏è Marketplace address ch∆∞a ƒë∆∞·ª£c set t·ª´ game!', 'error');
                    return;
                }

                // Validate address
                if (!web3.utils.isAddress(marketplaceAddress)) {
                    showStatus(`‚ùå Marketplace address kh√¥ng h·ª£p l·ªá: ${marketplaceAddress}`, 'error');
                    return;
                }

                marketplaceAddress = web3.utils.toChecksumAddress(marketplaceAddress);

                console.log('Marketplace Address:', marketplaceAddress);
                console.log('Token ID:', tokenId);

                marketplaceContract = new web3.eth.Contract(MARKETPLACE_ABI, marketplaceAddress);

                // Enable cancel button
                document.getElementById('connectBtn').innerHTML = 'üîó ƒê√£ k·∫øt n·ªëi';
                document.getElementById('cancelBtn').disabled = false;

                // Check network
                if (chainId != 80002) {
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('switchNetworkBtn').disabled = false;
                    document.getElementById('cancelBtn').disabled = true;
                    showStatus(`‚ö†Ô∏è ƒêang ·ªü network kh√°c (Chain ID: ${chainId}). Vui l√≤ng chuy·ªÉn sang Polygon Amoy (80002)`, 'error');
                } else {
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    showStatus(`‚úÖ ƒê√£ k·∫øt n·ªëi! ƒê·ªãa ch·ªâ: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}`, 'success');
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        showStatus('‚ö†Ô∏è MetaMask ƒë√£ b·ªã ng·∫Øt k·∫øt n·ªëi', 'error');
                        location.reload();
                    } else {
                        userAccount = accounts[0];
                        document.getElementById('walletAddress').textContent = userAccount;
                        showStatus('‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi t√†i kho·∫£n', 'success');
                    }
                });

                // Listen for network changes
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                
                if (error.code === 4001) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                } else if (error.code === -32002) {
                    showStatus('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n t·ª´ MetaMask...', 'info');
                } else {
                    showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                }
            }
        }

        // Chuy·ªÉn sang Polygon Amoy
        async function switchToAmoy() {
            await ensureAmoyNetwork();
        }

        async function ensureAmoyNetwork() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask kh√¥ng kh·∫£ d·ª•ng!', 'error');
                    return false;
                }

                const chainId = await web3.eth.getChainId();
                const amoyChainId = '0x13882'; // 80002 in hex

                if (chainId == 80002) {
                    return true;
                }

                showStatus('‚è≥ ƒêang chuy·ªÉn sang Polygon Amoy Testnet...', 'info');

                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: amoyChainId }],
                    });
                    showStatus('‚úÖ ƒê√£ chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    return true;
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: amoyChainId,
                                        chainName: 'Polygon Amoy Testnet',
                                        nativeCurrency: {
                                            name: 'POL',
                                            symbol: 'POL',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://rpc-amoy.polygon.technology'],
                                        blockExplorerUrls: ['https://www.oklink.com/amoy']
                                    }
                                ],
                            });
                            showStatus('‚úÖ ƒê√£ th√™m v√† chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                            return true;
                        } catch (addError) {
                            console.error('Error adding network:', addError);
                            showStatus('‚ùå Kh√¥ng th·ªÉ th√™m Polygon Amoy network. Vui l√≤ng th√™m th·ªß c√¥ng trong MetaMask.', 'error');
                            return false;
                        }
                    } else if (switchError.code === 4001) {
                        showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi chuy·ªÉn network', 'error');
                        return false;
                    } else {
                        console.error('Error switching network:', switchError);
                        showStatus('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn network. Vui l√≤ng chuy·ªÉn th·ªß c√¥ng sang Polygon Amoy trong MetaMask.', 'error');
                        return false;
                    }
                }
            } catch (error) {
                console.error('Error ensuring Amoy network:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                return false;
            }
        }

        // H·ªßy listing
        async function cancelListing() {
            try {
                if (!marketplaceContract || !userAccount) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                    return;
                }

                if (!tokenId) {
                    showStatus('‚ùå Token ID ch∆∞a ƒë∆∞·ª£c set t·ª´ game!', 'error');
                    return;
                }

                // ƒê·∫£m b·∫£o ƒëang ·ªü ƒë√∫ng network
                const chainId = await web3.eth.getChainId();
                if (chainId != 80002) {
                    showStatus('‚ö†Ô∏è Vui l√≤ng chuy·ªÉn sang Polygon Amoy Testnet tr∆∞·ªõc!', 'error');
                    document.getElementById('cancelBtn').innerHTML = 'üö´ H·ªßy B√°n';
                    document.getElementById('cancelBtn').disabled = false;
                    return;
                }

                showStatus('‚è≥ ƒêang ∆∞·ªõc t√≠nh gas...', 'info');
                document.getElementById('cancelBtn').disabled = true;
                document.getElementById('cancelBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                // Convert tokenId to BigInt
                const tokenIdBigInt = BigInt(tokenId.startsWith('0x') ? tokenId : `0x${parseInt(tokenId).toString(16)}`);

                // Estimate gas
                let gasEstimate;
                try {
                    gasEstimate = await marketplaceContract.methods.cancelListing(tokenIdBigInt).estimateGas({
                        from: userAccount
                    });
                    console.log('Gas estimate for cancelListing:', gasEstimate);
                    // Th√™m 30% buffer
                    gasEstimate = Math.floor(Number(gasEstimate) * 1.3);
                } catch (estimateError) {
                    console.error('Gas estimation error:', estimateError);
                    gasEstimate = 100000; // Default gas limit
                    showStatus('‚ö†Ô∏è Kh√¥ng th·ªÉ estimate gas, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh', 'info');
                }

                // Check balance
                try {
                    const balance = await web3.eth.getBalance(userAccount);
                    const gasPrice = await web3.eth.getGasPrice();
                    const gasCost = BigInt(gasEstimate) * BigInt(gasPrice);
                    if (BigInt(balance) < gasCost) {
                        showStatus('‚ùå Kh√¥ng ƒë·ªß POL ƒë·ªÉ tr·∫£ gas fee!', 'error');
                        document.getElementById('cancelBtn').innerHTML = 'üö´ H·ªßy B√°n';
                        document.getElementById('cancelBtn').disabled = false;
                        return;
                    }
                } catch (balanceError) {
                    console.warn('Could not check balance:', balanceError);
                }

                // Setup gas parameters (EIP-1559 ho·∫∑c gasPrice)
                let txParams = {
                    from: userAccount,
                    gas: gasEstimate
                };

                try {
                    // Th·ª≠ d√πng EIP-1559
                    const block = await web3.eth.getBlock('latest');
                    const baseFee = block.baseFeePerGas || await web3.eth.getGasPrice();
                    
                    // Priority fee cao ƒë·ªÉ ƒë·∫£m b·∫£o transaction ƒë∆∞·ª£c x·ª≠ l√Ω
                    const maxPriorityFeePerGas = BigInt(web3.utils.toWei('30', 'gwei'));
                    // Max fee = baseFee * 5 + priority fee (cao ƒë·ªÉ match "Cao" option trong MetaMask)
                    const baseFeeBigInt = BigInt(baseFee);
                    const maxFeePerGas = baseFeeBigInt * BigInt(5) + maxPriorityFeePerGas;
                    
                    txParams.maxFeePerGas = maxFeePerGas.toString();
                    txParams.maxPriorityFeePerGas = maxPriorityFeePerGas.toString();
                    
                    console.log('Using EIP-1559 for cancelListing:', {
                        maxFeePerGas: web3.utils.fromWei(maxFeePerGas.toString(), 'gwei') + ' gwei',
                        maxPriorityFeePerGas: web3.utils.fromWei(maxPriorityFeePerGas.toString(), 'gwei') + ' gwei'
                    });
                } catch (eip1559Error) {
                    // Fallback v·ªÅ gasPrice
                    console.warn('EIP-1559 not supported, using gasPrice:', eip1559Error);
                    try {
                        const networkGasPrice = await web3.eth.getGasPrice();
                        txParams.gasPrice = (BigInt(networkGasPrice) * BigInt(200) / BigInt(100)).toString(); // 200% c·ªßa network gas price
                        console.log('Using gasPrice for cancelListing (200% of network):', txParams.gasPrice);
                    } catch (gasPriceError) {
                        txParams.gasPrice = web3.utils.toWei('100', 'gwei'); // Default cao
                        console.log('Using default gasPrice for cancelListing: 100 gwei');
                    }
                }

                // Dry run ƒë·ªÉ check revert
                try {
                    await marketplaceContract.methods.cancelListing(tokenIdBigInt).call({
                        from: userAccount
                    });
                    console.log('‚úÖ Call successful - transaction should work');
                } catch (callError) {
                    console.error('‚ùå Call failed - transaction will revert:', callError);
                    showStatus(`‚ùå Transaction s·∫Ω b·ªã revert: ${callError.message}`, 'error');
                    document.getElementById('cancelBtn').innerHTML = 'üö´ H·ªßy B√°n';
                    document.getElementById('cancelBtn').disabled = false;
                    return;
                }

                showStatus('‚è≥ ƒêang g·ª≠i giao d·ªãch...', 'info');

                // Send cancelListing transaction
                const tx = await marketplaceContract.methods.cancelListing(tokenIdBigInt).send(txParams);

                showStatus(`‚úÖ H·ªßy b√°n th√†nh c√¥ng! Transaction: ${tx.transactionHash}`, 'success');
                document.getElementById('cancelBtn').innerHTML = 'üö´ H·ªßy B√°n';
                document.getElementById('cancelBtn').disabled = false;

            } catch (error) {
                console.error('Error canceling listing:', error);
                
                let errorMsg = '‚ùå L·ªói khi h·ªßy b√°n!';
                
                if (error.message) {
                    if (error.message.includes('user rejected') || error.message.includes('User denied')) {
                        errorMsg = '‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi giao d·ªãch';
                    } else if (error.message.includes('Internal JSON-RPC error')) {
                        errorMsg = '‚ùå L·ªói RPC n·ªôi b·ªô. C√≥ th·ªÉ do gas limit qu√° th·∫•p ho·∫∑c network kh√¥ng ƒë√∫ng.';
                    } else if (error.message.includes('execution reverted')) {
                        errorMsg = '‚ùå Transaction b·ªã revert. Ki·ªÉm tra l·∫°i b·∫°n c√≥ ph·∫£i l√† seller c·ªßa item n√†y kh√¥ng.';
                    } else if (error.message.includes('insufficient funds')) {
                        errorMsg = '‚ùå Kh√¥ng ƒë·ªß POL ƒë·ªÉ tr·∫£ gas fee. Vui l√≤ng n·∫°p th√™m POL v√†o v√≠.';
                    } else {
                        errorMsg = `‚ùå ${error.message}`;
                    }
                }

                showStatus(errorMsg, 'error');
                document.getElementById('cancelBtn').innerHTML = 'üö´ H·ªßy B√°n';
                document.getElementById('cancelBtn').disabled = false;
            }
        }

        // Load URL params khi trang load
        window.addEventListener('load', () => {
            getURLParams();
            
            if (window.location.protocol === 'file:') {
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - MetaMask c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông! Vui l√≤ng ch·∫°y qua HTTP server.', 'error');
            } else {
                showStatus('‚ÑπÔ∏è Vui l√≤ng click "K·∫øt n·ªëi MetaMask" ƒë·ªÉ b·∫Øt ƒë·∫ßu', 'info');
            }
        });
    </script>
</body>
</html>


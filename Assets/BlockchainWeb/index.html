<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RareItem Withdraw - MetaMask</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box.error {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .status-box.success {
            border-left-color: #27ae60;
            background: #efe;
        }

        .status-box.info {
            border-left-color: #3498db;
            background: #eef;
        }

        .status-text {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .wallet-info {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }

        input[readonly]:focus {
            border-color: #d0d0d0;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ RareItem Withdraw</h1>
        <p class="subtitle">K·∫øt n·ªëi MetaMask ƒë·ªÉ mint NFT t·ª´ game</p>

        <div id="statusBox" class="status-box info">
            <div class="status-text">ƒêang ch·ªù k·∫øt n·ªëi MetaMask...</div>
        </div>

        <div id="fileProtocolWarning" class="status-box error" style="display: none;">
            <div class="status-text">
                <strong>‚ö†Ô∏è C·∫£nh b√°o:</strong> ƒêang ch·∫°y t·ª´ file:// - MetaMask s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!<br><br>
                <strong>Gi·∫£i ph√°p:</strong><br>
                1. M·ªü Terminal/PowerShell trong th∆∞ m·ª•c ch·ª©a file n√†y<br>
                2. Ch·∫°y: <code>python -m http.server 8000</code> (ho·∫∑c <code>npx http-server</code>)<br>
                3. M·ªü tr√¨nh duy·ªát: <code>http://localhost:8000</code>
            </div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <strong>ƒê·ªãa ch·ªâ v√≠:</strong>
            <div class="wallet-address" id="walletAddress"></div>
            <div class="network-info" id="networkInfo"></div>
        </div>

        <div class="form-group">
            <label for="contractAddress">Contract Address (RareItem):</label>
            <input type="text" id="contractAddress" placeholder="0x..." value="" readonly>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">T·ª± ƒë·ªông t·ª´ game - kh√¥ng th·ªÉ ch·ªânh s·ª≠a</small>
        </div>

        <div class="form-group">
            <label for="tokenURI">Token URI (Metadata):</label>
            <input type="text" id="tokenURI" placeholder="ipfs://... ho·∫∑c https://..." value="" readonly>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">T·ª± ƒë·ªông t·ª´ game - kh√¥ng th·ªÉ ch·ªânh s·ª≠a</small>
        </div>

        <button id="connectBtn" onclick="connectWallet()">üîó K·∫øt n·ªëi MetaMask</button>
        <button id="switchNetworkBtn" onclick="switchToAmoy()" disabled class="button-secondary" style="display: none;">üîÑ Chuy·ªÉn sang Polygon Amoy</button>
        <button id="mintBtn" onclick="mintNFT()" disabled>‚ú® Mint NFT (Withdraw)</button>
        <button id="checkBalanceBtn" onclick="checkBalance()" disabled class="button-secondary">üìä Ki·ªÉm tra s·ªë l∆∞·ª£ng NFT</button>
    </div>

    <script>
        let web3;
        let userAccount;
        let contract;
        let contractAddress = ''; // S·∫Ω ƒë∆∞·ª£c set t·ª´ URL params ho·∫∑c input

        // ABI c·ªßa contract RareItem (ch·ªâ c√°c h√†m c·∫ßn thi·∫øt)
        const RARE_ITEM_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "to", "type": "address"},
                    {"internalType": "string", "name": "uri", "type": "string"}
                ],
                "name": "adminMint",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "string", "name": "uri", "type": "string"}
                ],
                "name": "mintForMyself",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}],
                "name": "tokenURI",
                "outputs": [{"internalType": "string", "name": "", "type": "string"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nextTokenId",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // L·∫•y contract address v√† token URI t·ª´ URL params
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            // L·∫•y contract address (b·∫Øt bu·ªôc t·ª´ game)
            const address = params.get('contract');
            if (address) {
                document.getElementById('contractAddress').value = address;
                contractAddress = address;
            } else {
                // N·∫øu kh√¥ng c√≥ t·ª´ URL, hi·ªÉn th·ªã c·∫£nh b√°o
                showStatus('‚ö†Ô∏è Contract Address ch∆∞a ƒë∆∞·ª£c set. Vui l√≤ng m·ªü t·ª´ game.', 'error');
            }
            
            // L·∫•y token URI (b·∫Øt bu·ªôc t·ª´ game)
            const uri = params.get('uri');
            if (uri) {
                document.getElementById('tokenURI').value = decodeURIComponent(uri);
            } else {
                // N·∫øu kh√¥ng c√≥ t·ª´ URL, hi·ªÉn th·ªã c·∫£nh b√°o
                if (!address) {
                    showStatus('‚ö†Ô∏è Token URI ch∆∞a ƒë∆∞·ª£c set. Vui l√≤ng m·ªü t·ª´ game.', 'error');
                }
            }
        }

        // Hi·ªÉn th·ªã status
        function showStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.querySelector('.status-text').textContent = message;
        }

        // Ki·ªÉm tra protocol v√† MetaMask
        function checkEnvironment() {
            const isFileProtocol = window.location.protocol === 'file:';
            
            if (isFileProtocol) {
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - MetaMask c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông! Vui l√≤ng ch·∫°y qua HTTP server (xem h∆∞·ªõng d·∫´n b√™n d∆∞·ªõi).', 'error');
                return false;
            }
            
            // Ki·ªÉm tra MetaMask v·ªõi nhi·ªÅu c√°ch
            if (typeof window.ethereum === 'undefined') {
                // Th·ª≠ ki·ªÉm tra l·∫°i sau 1 gi√¢y (c√≥ th·ªÉ extension ch∆∞a load xong)
                setTimeout(() => {
                    if (typeof window.ethereum === 'undefined') {
                        showStatus('‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ho·∫∑c ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t! Vui l√≤ng:\n1. C√†i ƒë·∫∑t MetaMask extension\n2. Refresh trang\n3. ƒê·∫£m b·∫£o ch·∫°y qua HTTP server (kh√¥ng ph·∫£i file://)', 'error');
                    }
                }, 1000);
                return false;
            }
            
            return true;
        }

        // K·∫øt n·ªëi MetaMask
        async function connectWallet() {
            try {
                // Ki·ªÉm tra environment tr∆∞·ªõc
                if (!checkEnvironment()) {
                    return;
                }

                // Ki·ªÉm tra l·∫°i MetaMask (c√≥ th·ªÉ ƒë√£ load sau khi check)
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask kh√¥ng kh·∫£ d·ª•ng! N·∫øu ƒë√£ c√†i ƒë·∫∑t, vui l√≤ng:\n1. Refresh trang (F5)\n2. ƒê·∫£m b·∫£o ch·∫°y qua HTTP server (localhost), kh√¥ng ph·∫£i file://', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang k·∫øt n·ªëi v·ªõi MetaMask...', 'info');

                // Y√™u c·∫ßu k·∫øt n·ªëi
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                // Kh·ªüi t·∫°o Web3
                web3 = new Web3(window.ethereum);

                // Hi·ªÉn th·ªã th√¥ng tin v√≠
                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';

                // L·∫•y network info
                const chainId = await web3.eth.getChainId();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    5: 'Goerli Testnet',
                    11155111: 'Sepolia Testnet',
                    80001: 'Mumbai Testnet',
                    80002: 'Polygon Amoy Testnet',
                    137: 'Polygon Mainnet',
                    1337: 'Localhost',
                    31337: 'Hardhat'
                };
                const networkName = networkNames[chainId] || `Chain ID: ${chainId}`;
                document.getElementById('networkInfo').textContent = `Network: ${networkName}`;

                // Ki·ªÉm tra v√† y√™u c·∫ßu chuy·ªÉn sang Polygon Amoy n·∫øu c·∫ßn
                await ensureAmoyNetwork();

                // L·∫•y contract address t·ª´ input (readonly, ƒë∆∞·ª£c set t·ª´ URL)
                contractAddress = document.getElementById('contractAddress').value.trim();
                if (!contractAddress) {
                    showStatus('‚ùå Contract Address ch∆∞a ƒë∆∞·ª£c set t·ª´ game! Vui l√≤ng m·ªü l·∫°i t·ª´ game.', 'error');
                    return;
                }

                // Validate contract address format
                if (!web3.utils.isAddress(contractAddress)) {
                    showStatus('‚ùå Contract Address kh√¥ng h·ª£p l·ªá!', 'error');
                    return;
                }

                // Convert v·ªÅ checksum address
                contractAddress = web3.utils.toChecksumAddress(contractAddress);
                document.getElementById('contractAddress').value = contractAddress;

                // Kh·ªüi t·∫°o contract
                contract = new web3.eth.Contract(RARE_ITEM_ABI, contractAddress);
                
                // Test contract connection b·∫±ng c√°ch g·ªçi m·ªôt view function
                try {
                    await contract.methods.nextTokenId().call();
                    console.log('Contract connection verified');
                } catch (testError) {
                    console.error('Contract connection test failed:', testError);
                    showStatus('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi contract. Ki·ªÉm tra l·∫°i address v√† network.', 'error');
                    return;
                }

                // Enable buttons
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('checkBalanceBtn').disabled = false;

                // Ki·ªÉm tra network v√† hi·ªÉn th·ªã n√∫t chuy·ªÉn network n·∫øu c·∫ßn
                if (chainId != 80002) {
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('switchNetworkBtn').disabled = false;
                    document.getElementById('mintBtn').disabled = true;
                    showStatus(`‚ö†Ô∏è ƒêang ·ªü network kh√°c (Chain ID: ${chainId}). Vui l√≤ng chuy·ªÉn sang Polygon Amoy (80002)`, 'error');
                } else {
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    document.getElementById('mintBtn').disabled = false;
                    showStatus(`‚úÖ ƒê√£ k·∫øt n·ªëi! ƒê·ªãa ch·ªâ: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}`, 'success');
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        showStatus('‚ö†Ô∏è MetaMask ƒë√£ b·ªã ng·∫Øt k·∫øt n·ªëi', 'error');
                        location.reload();
                    } else {
                        userAccount = accounts[0];
                        document.getElementById('walletAddress').textContent = userAccount;
                        showStatus('‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi t√†i kho·∫£n', 'success');
                    }
                });

                // Listen for network changes
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        // Chuy·ªÉn sang Polygon Amoy (c√≥ th·ªÉ g·ªçi t·ª´ button)
        async function switchToAmoy() {
            await ensureAmoyNetwork();
        }

        // ƒê·∫£m b·∫£o ƒëang ·ªü m·∫°ng Polygon Amoy (Chain ID: 80002)
        async function ensureAmoyNetwork() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask kh√¥ng kh·∫£ d·ª•ng!', 'error');
                    return false;
                }

                const chainId = await web3.eth.getChainId();
                const amoyChainId = '0x13882'; // 80002 in hex

                // N·∫øu ƒë√£ ·ªü ƒë√∫ng network, kh√¥ng c·∫ßn l√†m g√¨
                if (chainId == 80002) {
                    return true;
                }

                showStatus('‚è≥ ƒêang chuy·ªÉn sang Polygon Amoy Testnet...', 'info');

                try {
                    // Th·ª≠ chuy·ªÉn network
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: amoyChainId }],
                    });
                    showStatus('‚úÖ ƒê√£ chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                    
                    // Reload ƒë·ªÉ c·∫≠p nh·∫≠t network info v√† contract
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    return true;
                } catch (switchError) {
                    // N·∫øu network ch∆∞a ƒë∆∞·ª£c th√™m v√†o MetaMask, th√™m n√≥
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: amoyChainId,
                                        chainName: 'Polygon Amoy Testnet',
                                        nativeCurrency: {
                                            name: 'POL',
                                            symbol: 'POL',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://rpc-amoy.polygon.technology'],
                                        blockExplorerUrls: ['https://www.oklink.com/amoy']
                                    }
                                ],
                            });
                            showStatus('‚úÖ ƒê√£ th√™m v√† chuy·ªÉn sang Polygon Amoy Testnet', 'success');
                            
                            // Reload ƒë·ªÉ c·∫≠p nh·∫≠t network info v√† contract
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                            return true;
                        } catch (addError) {
                            console.error('Error adding network:', addError);
                            showStatus('‚ùå Kh√¥ng th·ªÉ th√™m Polygon Amoy network. Vui l√≤ng th√™m th·ªß c√¥ng trong MetaMask.', 'error');
                            return false;
                        }
                    } else if (switchError.code === 4001) {
                        // User rejected
                        showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi chuy·ªÉn network', 'error');
                        return false;
                    } else {
                        console.error('Error switching network:', switchError);
                        showStatus('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn network. Vui l√≤ng chuy·ªÉn th·ªß c√¥ng sang Polygon Amoy trong MetaMask.', 'error');
                        return false;
                    }
                }

            } catch (error) {
                console.error('Error ensuring Amoy network:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                return false;
            }
        }

        // Mint NFT
        async function mintNFT() {
            try {
                if (!contract || !userAccount) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                    return;
                }

                // ƒê·∫£m b·∫£o ƒëang ·ªü ƒë√∫ng network tr∆∞·ªõc khi mint
                const chainId = await web3.eth.getChainId();
                if (chainId != 80002) {
                    showStatus('‚ö†Ô∏è Vui l√≤ng chuy·ªÉn sang Polygon Amoy Testnet tr∆∞·ªõc!', 'error');
                    document.getElementById('mintBtn').innerHTML = '‚ú® Mint NFT (Withdraw)';
                    document.getElementById('mintBtn').disabled = false;
                    return;
                }

                const tokenURI = document.getElementById('tokenURI').value.trim();
                if (!tokenURI) {
                    showStatus('‚ùå Token URI ch∆∞a ƒë∆∞·ª£c set t·ª´ game! Vui l√≤ng m·ªü l·∫°i t·ª´ game.', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang ∆∞·ªõc t√≠nh gas...', 'info');
                document.getElementById('mintBtn').disabled = true;
                document.getElementById('mintBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                // Estimate gas tr∆∞·ªõc
                let gasEstimate;
                try {
                    gasEstimate = await contract.methods.mintForMyself(tokenURI).estimateGas({
                        from: userAccount
                    });
                    console.log('Gas estimate:', gasEstimate);
                    // Th√™m 20% buffer
                    gasEstimate = Math.floor(gasEstimate * 1.2);
                } catch (estimateError) {
                    console.error('Gas estimation error:', estimateError);
                    // N·∫øu estimate fail, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh cao h∆°n
                    gasEstimate = 500000;
                    showStatus('‚ö†Ô∏è Kh√¥ng th·ªÉ estimate gas, d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh', 'info');
                }

                // Ki·ªÉm tra balance tr∆∞·ªõc khi mint
                try {
                    const balance = await web3.eth.getBalance(userAccount);
                    const gasCost = web3.utils.toBN(gasEstimate).mul(web3.utils.toBN(await web3.eth.getGasPrice()));
                    if (web3.utils.toBN(balance).lt(gasCost)) {
                        showStatus('‚ùå Kh√¥ng ƒë·ªß POL ƒë·ªÉ tr·∫£ gas fee!', 'error');
                        document.getElementById('mintBtn').innerHTML = '‚ú® Mint NFT (Withdraw)';
                        document.getElementById('mintBtn').disabled = false;
                        return;
                    }
                } catch (balanceError) {
                    console.warn('Could not check balance:', balanceError);
                }

                // L·∫•y gas price (Polygon Amoy s·ª≠ d·ª•ng EIP-1559)
                let txParams = {
                    from: userAccount,
                    gas: gasEstimate
                };

                try {
                    // Th·ª≠ d√πng EIP-1559 (maxFeePerGas, maxPriorityFeePerGas)
                    const block = await web3.eth.getBlock('latest');
                    const baseFee = block.baseFeePerGas || await web3.eth.getGasPrice();
                    
                    // Priority fee (tip) - th∆∞·ªùng l√† 2-5 gwei cho testnet
                    const maxPriorityFeePerGas = web3.utils.toWei('2', 'gwei');
                    // Max fee = base fee * 2 + priority fee
                    const maxFeePerGas = web3.utils.toBN(baseFee).mul(web3.utils.toBN(2)).add(web3.utils.toBN(maxPriorityFeePerGas)).toString();
                    
                    txParams.maxFeePerGas = maxFeePerGas;
                    txParams.maxPriorityFeePerGas = maxPriorityFeePerGas;
                    
                    console.log('Using EIP-1559:', {
                        maxFeePerGas: web3.utils.fromWei(maxFeePerGas, 'gwei') + ' gwei',
                        maxPriorityFeePerGas: web3.utils.fromWei(maxPriorityFeePerGas, 'gwei') + ' gwei'
                    });
                } catch (eip1559Error) {
                    // Fallback v·ªÅ gasPrice n·∫øu kh√¥ng support EIP-1559
                    console.warn('EIP-1559 not supported, using gasPrice:', eip1559Error);
                    try {
                        txParams.gasPrice = await web3.eth.getGasPrice();
                    } catch (gasPriceError) {
                        txParams.gasPrice = web3.utils.toWei('30', 'gwei');
                    }
                }

                showStatus('‚è≥ ƒêang g·ª≠i giao d·ªãch...', 'info');

                // G·ªçi h√†m mintForMyself v·ªõi gas ƒë√£ estimate
                const tx = await contract.methods.mintForMyself(tokenURI).send(txParams);

                showStatus(`‚úÖ Mint th√†nh c√¥ng! Transaction: ${tx.transactionHash}`, 'success');
                document.getElementById('mintBtn').innerHTML = '‚ú® Mint NFT (Withdraw)';
                document.getElementById('mintBtn').disabled = false;

                // T·ª± ƒë·ªông check balance sau khi mint
                setTimeout(checkBalance, 2000);

            } catch (error) {
                console.error('Error minting NFT:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    data: error.data,
                    stack: error.stack
                });

                let errorMsg = '‚ùå L·ªói khi mint NFT!';
                
                // Parse error message chi ti·∫øt h∆°n
                if (error.message) {
                    if (error.message.includes('user rejected') || error.message.includes('User denied')) {
                        errorMsg = '‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi giao d·ªãch';
                    } else if (error.message.includes('Internal JSON-RPC error')) {
                        // L·∫•y chi ti·∫øt l·ªói t·ª´ data n·∫øu c√≥
                        let detailMsg = 'L·ªói RPC n·ªôi b·ªô. ';
                        if (error.data) {
                            detailMsg += `Chi ti·∫øt: ${JSON.stringify(error.data)}`;
                        } else if (error.message.includes('execution reverted')) {
                            detailMsg += 'Transaction b·ªã revert. Ki·ªÉm tra l·∫°i contract address v√† parameters.';
                        } else {
                            detailMsg += 'C√≥ th·ªÉ do: gas limit qu√° th·∫•p, contract address sai, ho·∫∑c network kh√¥ng ƒë√∫ng.';
                        }
                        errorMsg = `‚ùå ${detailMsg}`;
                    } else if (error.message.includes('execution reverted')) {
                        errorMsg = '‚ùå Transaction b·ªã revert. Ki·ªÉm tra l·∫°i contract address v√† parameters.';
                    } else if (error.message.includes('insufficient funds')) {
                        errorMsg = '‚ùå Kh√¥ng ƒë·ªß POL ƒë·ªÉ tr·∫£ gas fee. Vui l√≤ng n·∫°p th√™m POL v√†o v√≠.';
                    } else if (error.message.includes('nonce')) {
                        errorMsg = '‚ùå L·ªói nonce. Vui l√≤ng th·ª≠ l·∫°i sau v√†i gi√¢y.';
                    } else {
                        errorMsg = `‚ùå ${error.message}`;
                    }
                }

                // Log th√™m th√¥ng tin ƒë·ªÉ debug
                if (contract) {
                    console.log('Contract address:', contract.options.address);
                    console.log('User account:', userAccount);
                    console.log('Token URI:', document.getElementById('tokenURI').value);
                }

                showStatus(errorMsg, 'error');
                document.getElementById('mintBtn').innerHTML = '‚ú® Mint NFT (Withdraw)';
                document.getElementById('mintBtn').disabled = false;
            }
        }

        // Ki·ªÉm tra s·ªë l∆∞·ª£ng NFT
        async function checkBalance() {
            try {
                if (!contract || !userAccount) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang ki·ªÉm tra...', 'info');

                const balance = await contract.methods.balanceOf(userAccount).call();
                const nextTokenId = await contract.methods.nextTokenId().call();

                showStatus(`üìä S·ªë l∆∞·ª£ng NFT c·ªßa b·∫°n: ${balance} | Next Token ID: ${nextTokenId}`, 'success');

            } catch (error) {
                console.error('Error checking balance:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        // Ki·ªÉm tra protocol khi load
        function checkProtocolOnLoad() {
            if (window.location.protocol === 'file:') {
                document.getElementById('fileProtocolWarning').style.display = 'block';
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - Vui l√≤ng ch·∫°y qua HTTP server!', 'error');
                return false;
            }
            return true;
        }

        // Auto-connect n·∫øu ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥
        window.addEventListener('load', async () => {
            getURLParams();
            
            // Ki·ªÉm tra protocol
            if (!checkProtocolOnLoad()) {
                return;
            }
            
            // Ki·ªÉm tra MetaMask
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        // ƒê√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥, t·ª± ƒë·ªông connect
                        connectWallet();
                    }
                } catch (error) {
                    console.error('Error checking accounts:', error);
                }
            } else {
                showStatus('‚ÑπÔ∏è Vui l√≤ng click "K·∫øt n·ªëi MetaMask" ƒë·ªÉ b·∫Øt ƒë·∫ßu', 'info');
            }
        });
    </script>
</body>
</html>


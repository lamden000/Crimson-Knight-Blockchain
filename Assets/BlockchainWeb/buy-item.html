<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Item - Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box.error {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .status-box.success {
            border-left-color: #27ae60;
            background: #efe;
        }

        .status-box.info {
            border-left-color: #3498db;
            background: #eef;
        }

        .status-text {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .wallet-info {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-top: 5px;
        }

        .item-info {
            background: #fff9e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            border-color: #d0d0d0;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6c757d;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí Buy Item</h1>
        <p class="subtitle">Mua NFT t·ª´ marketplace</p>

        <div id="statusBox" class="status-box info">
            <div class="status-text">ƒêang ch·ªù k·∫øt n·ªëi MetaMask...</div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <strong>ƒê·ªãa ch·ªâ v√≠:</strong>
            <div class="wallet-address" id="walletAddress"></div>
            <div class="network-info" id="networkInfo"></div>
        </div>

        <div id="itemInfo" class="item-info" style="display: none;">
            <strong>Th√¥ng tin Item:</strong>
            <div style="margin-top: 10px;">
                <div>Token ID: <strong id="tokenId">-</strong></div>
                <div>Gi√°: <strong id="price">-</strong> GTK</div>
            </div>
        </div>

        <div class="form-group">
            <label for="marketplaceAddress">Marketplace Contract:</label>
            <input type="text" id="marketplaceAddress" placeholder="0x..." value="" readonly>
        </div>

        <div class="form-group">
            <label for="tokenAddress">GameToken Contract:</label>
            <input type="text" id="tokenAddress" placeholder="0x..." value="" readonly>
        </div>

        <button id="connectBtn" onclick="connectWallet()">üîó K·∫øt n·ªëi MetaMask</button>
        <button id="switchNetworkBtn" onclick="switchToAmoy()" disabled class="button-secondary" style="display: none;">üîÑ Chuy·ªÉn sang Polygon Amoy</button>
        <button id="approveBtn" onclick="approveToken()" disabled>‚úÖ Approve Token</button>
        <button id="buyBtn" onclick="buyItem()" disabled>üõí Buy Item</button>
    </div>

    <script>
        let web3;
        let userAccount;
        let marketplaceContract;
        let tokenContract;
        let marketplaceAddress = '';
        let tokenAddress = '';
        let tokenId = '';
        let price = '';

        // ABI c·ªßa Marketplace contract
        const MARKETPLACE_ABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
                ],
                "name": "buyItem",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // ABI c·ªßa ERC20 (approve, allowance)
        const ERC20_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "spender", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "owner", "type": "address"},
                    {"internalType": "address", "name": "spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "account", "type": "address"}
                ],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // L·∫•y parameters t·ª´ URL
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            marketplaceAddress = params.get('marketplace') || '';
            tokenAddress = params.get('token') || '';
            tokenId = params.get('tokenId') || '';
            price = params.get('price') || '';

            if (marketplaceAddress) {
                document.getElementById('marketplaceAddress').value = marketplaceAddress;
            }
            if (tokenAddress) {
                document.getElementById('tokenAddress').value = tokenAddress;
            }
            if (tokenId) {
                document.getElementById('tokenId').textContent = tokenId;
                document.getElementById('itemInfo').style.display = 'block';
            }
            if (price) {
                document.getElementById('price').textContent = price;
            }
        }

        function showStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.querySelector('.status-text').textContent = message;
        }

        // K·∫øt n·ªëi MetaMask
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang y√™u c·∫ßu k·∫øt n·ªëi MetaMask... Vui l√≤ng x√°c nh·∫≠n trong popup MetaMask.', 'info');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerHTML = '<span class="loading"></span>ƒêang ch·ªù x√°c nh·∫≠n...';

                // Revoke permissions tr∆∞·ªõc ƒë·ªÉ force popup ch·ªçn t√†i kho·∫£n
                try {
                    const permissions = await window.ethereum.request({
                        method: 'wallet_getPermissions'
                    });
                    
                    if (permissions && permissions.length > 0) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_revokePermissions',
                                params: [{ eth_accounts: {} }]
                            });
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (e) {
                            console.log('Cannot revoke permissions:', e);
                        }
                    }
                } catch (e) {
                    console.log('wallet_getPermissions not supported:', e);
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                    return;
                }

                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);

                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';

                const chainId = await web3.eth.getChainId();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    80002: 'Polygon Amoy Testnet',
                    137: 'Polygon Mainnet'
                };
                const networkName = networkNames[chainId] || `Chain ID: ${chainId}`;
                document.getElementById('networkInfo').textContent = `Network: ${networkName}`;

                await ensureAmoyNetwork();

                if (!marketplaceAddress || !tokenAddress) {
                    showStatus('‚ö†Ô∏è Contract addresses ch∆∞a ƒë∆∞·ª£c set t·ª´ game!', 'error');
                    return;
                }

                marketplaceAddress = web3.utils.toChecksumAddress(marketplaceAddress);
                tokenAddress = web3.utils.toChecksumAddress(tokenAddress);

                marketplaceContract = new web3.eth.Contract(MARKETPLACE_ABI, marketplaceAddress);
                tokenContract = new web3.eth.Contract(ERC20_ABI, tokenAddress);

                // Check token balance
                const balance = await tokenContract.methods.balanceOf(userAccount).call();
                const priceInWei = web3.utils.toWei(price || '0', 'ether');
                if (web3.utils.toBN(balance).lt(web3.utils.toBN(priceInWei))) {
                    showStatus('‚ùå Kh√¥ng ƒë·ªß token ƒë·ªÉ mua!', 'error');
                }

                document.getElementById('connectBtn').innerHTML = 'üîó ƒê√£ k·∫øt n·ªëi';
                document.getElementById('approveBtn').disabled = false;

                const currentChainId = await web3.eth.getChainId();
                if (currentChainId != 80002) {
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('switchNetworkBtn').disabled = false;
                } else {
                    showStatus('‚úÖ ƒê√£ k·∫øt n·ªëi!', 'success');
                }

            } catch (error) {
                console.error('Error connecting wallet:', error);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                
                if (error.code === 4001) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                } else if (error.code === -32002) {
                    showStatus('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n t·ª´ MetaMask...', 'info');
                } else {
                    showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                }
            }
        }

        // Chuy·ªÉn sang Polygon Amoy
        async function switchToAmoy() {
            await ensureAmoyNetwork();
        }

        async function ensureAmoyNetwork() {
            try {
                const chainId = await web3.eth.getChainId();
                if (chainId == 80002) return true;

                showStatus('‚è≥ ƒêang chuy·ªÉn sang Polygon Amoy...', 'info');
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x13882' }],
                });
                setTimeout(() => location.reload(), 1500);
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x13882',
                            chainName: 'Polygon Amoy Testnet',
                            nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
                            rpcUrls: ['https://rpc-amoy.polygon.technology'],
                            blockExplorerUrls: ['https://www.oklink.com/amoy']
                        }],
                    });
                    setTimeout(() => location.reload(), 1500);
                    return true;
                }
                showStatus('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn network.', 'error');
                return false;
            }
        }

        // Approve Token
        async function approveToken() {
            try {
                if (!tokenContract || !userAccount || !price) {
                    showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask v√† c√≥ gi√°!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang approve token...', 'info');
                document.getElementById('approveBtn').disabled = true;
                document.getElementById('approveBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                // Convert price to wei
                const priceInWei = web3.utils.toWei(price, 'ether');

                // Check if already approved
                const allowance = await tokenContract.methods.allowance(userAccount, marketplaceAddress).call();
                if (web3.utils.toBN(allowance).gte(web3.utils.toBN(priceInWei))) {
                    showStatus('‚úÖ Token ƒë√£ ƒë∆∞·ª£c approve ƒë·ªß!', 'success');
                    document.getElementById('buyBtn').disabled = false;
                    document.getElementById('approveBtn').innerHTML = '‚úÖ ƒê√£ Approve';
                    return;
                }

                // Approve v·ªõi s·ªë l∆∞·ª£ng l·ªõn h∆°n ƒë·ªÉ tr√°nh ph·∫£i approve nhi·ªÅu l·∫ßn
                const maxApproval = web3.utils.toWei('1000000', 'ether'); // Approve 1M tokens
                const tx = await tokenContract.methods.approve(marketplaceAddress, maxApproval).send({
                    from: userAccount
                });

                showStatus(`‚úÖ ƒê√£ approve token! Transaction: ${tx.transactionHash}`, 'success');
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('approveBtn').innerHTML = '‚úÖ ƒê√£ Approve';

            } catch (error) {
                console.error('Error approving token:', error);
                if (error.message && error.message.includes('user rejected')) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi giao d·ªãch approve', 'error');
                } else {
                    showStatus(`‚ùå L·ªói approve: ${error.message}`, 'error');
                }
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('approveBtn').innerHTML = '‚úÖ Approve Token';
            }
        }

        // Buy item
        async function buyItem() {
            try {
                if (!marketplaceContract || !userAccount || !tokenId) {
                    showStatus('‚ùå Thi·∫øu th√¥ng tin!', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang mua item...', 'info');
                document.getElementById('buyBtn').disabled = true;
                document.getElementById('buyBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                const tx = await marketplaceContract.methods.buyItem(tokenId).send({
                    from: userAccount
                });

                showStatus(`‚úÖ ƒê√£ mua item th√†nh c√¥ng! Transaction: ${tx.transactionHash}`, 'success');
                document.getElementById('buyBtn').innerHTML = '‚úÖ ƒê√£ Mua';

            } catch (error) {
                console.error('Error buying item:', error);
                if (error.message && error.message.includes('user rejected')) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi giao d·ªãch mua', 'error');
                } else {
                    showStatus(`‚ùå L·ªói mua: ${error.message}`, 'error');
                }
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('buyBtn').innerHTML = 'üõí Buy Item';
            }
        }

        window.addEventListener('load', () => {
            getURLParams();
            if (window.location.protocol === 'file:') {
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - Vui l√≤ng ch·∫°y qua HTTP server!', 'error');
            }
        });
    </script>
</body>
</html>


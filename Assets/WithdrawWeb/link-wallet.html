<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Wallet - MetaMask</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box.error {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .status-box.success {
            border-left-color: #27ae60;
            background: #efe;
        }

        .status-box.info {
            border-left-color: #3498db;
            background: #eef;
        }

        .status-text {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .wallet-info {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            word-break: break-all;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .file-protocol-warning {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Link Wallet</h1>
        <p class="subtitle">K·∫øt n·ªëi MetaMask ƒë·ªÉ li√™n k·∫øt v√≠ v·ªõi game</p>

        <div id="fileProtocolWarning" class="file-protocol-warning" style="display: none;">
            <div class="status-text">
                <strong>‚ö†Ô∏è C·∫£nh b√°o:</strong> ƒêang ch·∫°y t·ª´ file:// - MetaMask s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!<br><br>
                <strong>Gi·∫£i ph√°p:</strong><br>
                1. M·ªü Terminal/PowerShell trong th∆∞ m·ª•c ch·ª©a file n√†y<br>
                2. Ch·∫°y: <code>python -m http.server 8000</code><br>
                3. M·ªü tr√¨nh duy·ªát: <code>http://localhost:8000</code>
            </div>
        </div>

        <div id="statusBox" class="status-box info">
            <div class="status-text">ƒêang ch·ªù k·∫øt n·ªëi MetaMask...</div>
        </div>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <strong>ƒê·ªãa ch·ªâ v√≠:</strong>
            <div class="wallet-address" id="walletAddress"></div>
            <div class="network-info" id="networkInfo"></div>
        </div>

        <button id="connectBtn" onclick="connectWallet()">üîó K·∫øt n·ªëi MetaMask</button>
        <button id="confirmBtn" onclick="confirmLinkWallet()" disabled>‚úÖ X√°c nh·∫≠n li√™n k·∫øt v√≠</button>
    </div>

    <script>
        let web3;
        let userAccount;
        let walletAddress = '';

        // Ki·ªÉm tra protocol khi load
        function checkProtocolOnLoad() {
            if (window.location.protocol === 'file:') {
                document.getElementById('fileProtocolWarning').style.display = 'block';
                showStatus('‚ö†Ô∏è ƒêang ch·∫°y t·ª´ file:// - Vui l√≤ng ch·∫°y qua HTTP server!', 'error');
                return false;
            }
            return true;
        }

        // Hi·ªÉn th·ªã status
        function showStatus(message, type = 'info') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box ${type}`;
            statusBox.querySelector('.status-text').textContent = message;
        }

        // K·∫øt n·ªëi MetaMask (lu√¥n hi·ªÉn th·ªã popup)
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t! Vui l√≤ng c√†i ƒë·∫∑t MetaMask extension.', 'error');
                    return;
                }

                showStatus('‚è≥ ƒêang y√™u c·∫ßu k·∫øt n·ªëi MetaMask... Vui l√≤ng x√°c nh·∫≠n trong popup MetaMask.', 'info');

                // Disable button ƒë·ªÉ tr√°nh click nhi·ªÅu l·∫ßn
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerHTML = '<span class="loading"></span>ƒêang ch·ªù x√°c nh·∫≠n...';

                // Ki·ªÉm tra v√† disconnect permissions tr∆∞·ªõc ƒë·ªÉ force popup
                try {
                    // Ki·ªÉm tra xem ƒë√£ c√≥ permissions ch∆∞a
                    const permissions = await window.ethereum.request({
                        method: 'wallet_getPermissions'
                    });
                    
                    // N·∫øu ƒë√£ c√≥ permissions, revoke ƒë·ªÉ force popup m·ªõi
                    if (permissions && permissions.length > 0) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_revokePermissions',
                                params: [{ eth_accounts: {} }]
                            });
                            showStatus('‚è≥ ƒê√£ ng·∫Øt k·∫øt n·ªëi. Vui l√≤ng x√°c nh·∫≠n l·∫°i trong popup MetaMask...', 'info');
                            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ MetaMask x·ª≠ l√Ω
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } catch (disconnectError) {
                            console.log('Cannot revoke permissions:', disconnectError);
                            // N·∫øu kh√¥ng h·ªó tr·ª£, v·∫´n ti·∫øp t·ª•c
                        }
                    }
                } catch (e) {
                    // N·∫øu kh√¥ng h·ªó tr·ª£ wallet_getPermissions, b·ªè qua
                    console.log('wallet_getPermissions not supported, continuing...');
                }

                // Lu√¥n d√πng eth_requestAccounts ƒë·ªÉ hi·ªÉn th·ªã popup x√°c nh·∫≠n
                // Sau khi revoke permissions, request m·ªõi s·∫Ω lu√¥n hi·ªÉn th·ªã popup
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                // Ki·ªÉm tra user c√≥ t·ª´ ch·ªëi kh√¥ng
                if (accounts.length === 0) {
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                    return;
                }

                userAccount = accounts[0];
                walletAddress = userAccount;

                // Kh·ªüi t·∫°o Web3
                web3 = new Web3(window.ethereum);

                // Hi·ªÉn th·ªã th√¥ng tin v√≠
                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';

                // L·∫•y network info
                const chainId = await web3.eth.getChainId();
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    5: 'Goerli Testnet',
                    11155111: 'Sepolia Testnet',
                    80001: 'Mumbai Testnet',
                    80002: 'Polygon Amoy Testnet',
                    137: 'Polygon Mainnet',
                    1337: 'Localhost',
                    31337: 'Hardhat'
                };
                const networkName = networkNames[chainId] || `Chain ID: ${chainId}`;
                document.getElementById('networkInfo').textContent = `Network: ${networkName}`;

                // Enable confirm button
                document.getElementById('connectBtn').innerHTML = 'üîó ƒê√£ k·∫øt n·ªëi';
                document.getElementById('confirmBtn').disabled = false;

                showStatus(`‚úÖ ƒê√£ k·∫øt n·ªëi! ƒê·ªãa ch·ªâ: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}`, 'success');

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        showStatus('‚ö†Ô∏è MetaMask ƒë√£ b·ªã ng·∫Øt k·∫øt n·ªëi', 'error');
                        location.reload();
                    } else {
                        userAccount = accounts[0];
                        walletAddress = userAccount;
                        document.getElementById('walletAddress').textContent = userAccount;
                        showStatus('‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi t√†i kho·∫£n', 'success');
                    }
                });

                // Listen for network changes
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                
                // Reset button
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                
                // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
                if (error.code === 4001) {
                    // User rejected the request
                    showStatus('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi MetaMask. Vui l√≤ng click l·∫°i ƒë·ªÉ th·ª≠.', 'error');
                } else if (error.code === -32002) {
                    // Request already pending
                    showStatus('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n t·ª´ MetaMask... Vui l√≤ng ki·ªÉm tra popup MetaMask.', 'info');
                    // ƒê·ª£i m·ªôt ch√∫t r·ªìi th·ª≠ l·∫°i
                    setTimeout(() => {
                        document.getElementById('connectBtn').disabled = false;
                        document.getElementById('connectBtn').innerHTML = 'üîó K·∫øt n·ªëi MetaMask';
                    }, 2000);
                } else {
                    showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                }
            }
        }

        // X√°c nh·∫≠n li√™n k·∫øt v√≠
        async function confirmLinkWallet() {
            if (!walletAddress) {
                showStatus('‚ùå Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                showStatus('‚è≥ ƒêang l∆∞u ƒë·ªãa ch·ªâ v√≠...', 'info');
                document.getElementById('confirmBtn').disabled = true;
                document.getElementById('confirmBtn').innerHTML = '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';

                // L∆∞u wallet address v√†o file ƒë·ªÉ Unity ƒë·ªçc
                // Format: wallet_address.txt v·ªõi n·ªôi dung l√† ƒë·ªãa ch·ªâ v√≠
                const walletData = {
                    address: walletAddress,
                    timestamp: new Date().toISOString()
                };

                // T·∫°o blob v√† download file (Unity s·∫Ω ƒë·ªçc file n√†y)
                const blob = new Blob([walletAddress], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wallet_address.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('‚úÖ ƒê√£ l∆∞u ƒë·ªãa ch·ªâ v√≠! Vui l√≤ng quay l·∫°i game.', 'success');
                
                // ƒê·ª£i m·ªôt ch√∫t r·ªìi ƒë√≥ng c·ª≠a s·ªï (n·∫øu ƒë∆∞·ª£c m·ªü t·ª´ Unity)
                setTimeout(() => {
                    // Th·ª≠ ƒë√≥ng c·ª≠a s·ªï n·∫øu ƒë∆∞·ª£c m·ªü b·ªüi script
                    if (window.opener) {
                        window.close();
                    }
                }, 2000);

            } catch (error) {
                console.error('Error saving wallet address:', error);
                showStatus(`‚ùå L·ªói: ${error.message}`, 'error');
                document.getElementById('confirmBtn').innerHTML = '‚úÖ X√°c nh·∫≠n li√™n k·∫øt v√≠';
                document.getElementById('confirmBtn').disabled = false;
            }
        }

        // Ki·ªÉm tra protocol khi load (kh√¥ng auto-connect)
        window.addEventListener('load', () => {
            checkProtocolOnLoad();
        });
    </script>
</body>
</html>

